<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Memory Tests</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
  </style>
</head>
<body>
  <!-- ─────── Main Page Content ─────── -->
  <div class="content">
    <h1 id="testTitle">🧠 Forward and Reverse Memory Span Test</h1>
    <p id="instructions">
      This is a training test for spatial and visual memory capacity.
      Follow the sequence of blocks (💃), and repeat them in the forward or reverse order.
    </p>

    <!-- Memory Span -->
    <div id="grid"></div>

    <!-- Digit Symbol Coding Test -->
    <div id="digit-symbol" style="display:none">
      <p id="instructions">
      Match the symbol shown above to its correct digit (1–3) using the legend below.
      </p>
      <div id="current-symbol" class="symbol-display"></div>
      <div id="legend-row" class="legend-container"></div>
      <div class="button-row">
        <button class="choice-btn" data-digit="1">1</button>
        <button class="choice-btn" data-digit="2">2</button>
        <button class="choice-btn" data-digit="3">3</button>
      </div>
      <div class="status">
        <p>Time left: <span id="timer">90</span> seconds</p>
        <p>Score: <span id="digit-score">0</span></p>
      </div>
    </div>

    <!-- Trail Making Test A -->
    <div id="trailA-test" style="display:none">
      <p id="instructions">
      Click numbers from 1 to 24 in order as fast as you can.
        Timer starts on first click.
      </p>
      <div id="trailA-grid" class="trail-grid"></div>
      <p id="trailA-timer"></p>
    </div>

    <!-- Trail Making Test B -->
    <div id="trailB-test" style="display:none">
      <p id="instructions">
      Click alternating numbers and letters (1-A-2-B…) as fast as you can.
        Timer starts on first click.
      </p>
      <div id="trailB-grid" class="trail-grid"></div>
      <p id="trailB-timer"></p>
    </div>

    <!-- Grammatical Reasoning Test -->
    <div id="grammatical" style="display:none">
      <div id="instruction" class="statement">Is the following statement true or false?</div>
      <div class="test-container">
        <div id="square" class="shape">□</div>
        <div id="triangle" class="shape">△</div>
      </div>
      <div id="statement" class="statement"></div>
      <div class="button-container">
        <button id="true-btn">True</button>
        <button id="false-btn">False</button>
      </div>
      <div id="timer" class="timer">Time: 45s</div>
      <div id="score" class="score"></div>
    </div>

    <!-- Progressive Matrices Test -->
    <div id="progressive" style="display:none">
      <p id="instructions">
      In this test, you'll see a 3×3 pattern with one missing piece (bottom right).
        Click the shape below that completes the pattern.
      </p>
      <div id="grid-container"></div>
      <div id="choices-container"></div>
      <div id="score-container">
        Score: <span id="pm-score">0</span><br>
        Trial: <span id="pm-trial">1/17</span>
      </div>
      <div id="message"></div>
    </div>

    <!-- Control Buttons & Results -->
    <button id="startBtn">Start Test</button>
    <button id="submitBtn" disabled>Submit</button>
    <p id="result"></p>

    <!-- Overlays & Final Results -->
    <div id="time-up-overlay" style="display: none;">
      <div id="time-up-box">✅ Time's up!</div>
    </div>


<div id="final-results" style="display: none; padding: 2em; text-align: center;">

  <h2>👤 Participant Information</h2>
  <p>Gender: <span id="user-gender"></span></p>
  <p>Age: <span id="user-age"></span></p>
  <p>Education: <span id="user-education"></span></p>

  <h2>🧠 Test Scores</h2>
  <ul id="final-scores-list" style="list-style: none; padding: 0;">
    <li>Memory Span (Forward): <span id="final-forward-score"></span></li>
    <li>Memory Span (Reverse): <span id="final-reverse-score"></span></li>
    <li>Digit Symbol Coding: <span id="final-digit-score"></span></li>
    <li>Trail Making A: <span id="final-trailsA-score"></span></li>
    <li>Trail Making B: <span id="final-trailsB-score"></span></li>
    <li>Grammatical Reasoning: <span id="final-grammar-score"></span></li>
    <li>Progressive Matrices: <span id="final-matrices-score"></span></li>
  </ul>

  <h3>🧠 ML Model Output</h3>
  <div id="model-results" style="display: none;">
    <p id="predictionResult"></p>
    <p id="probabilityResult"></p>
  </div>

  <h3>📊 Cognitive Domain Percentiles</h3>
  <div id="percentile-results" style="display: none; margin-top: 1.5em;">
    <p><strong>Memory:</strong> <span id="memory-percentile"></span></p>
    <p><strong>Executive:</strong> <span id="executive-percentile"></span></p>
    <p><strong>Reasoning:</strong> <span id="reasoning-percentile"></span></p>
  </div>

    <button id="submit-data" onclick="submitAllData()">Submit All Data</button>

</div>




<!-- Results container-->
<div id="results" style="display:none; padding:1em; border:1px solid #ccc; margin-top:1em;"></div>

  <!-- Participant Info Modal-->
  <div id="user-info-modal">
    <div id="user-info-form">
      <h2>👤 Participant Information</h2>

      <label>Gender:
        <select id="gender">
          <option value="">Select</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </label><br><br>

      <label>Age:
        <input type="number" id="age" min="10" max="120" required>
      </label><br><br>

      <label>Education Level:
        <select id="education">
          <option value="">Select</option>
          <option value="high_school">High School</option>
          <option value="undergrad">Undergraduate</option>
          <option value="postgrad">Postgraduate</option>
        </select>
      </label><br><br>

       <div id="user-info-error" class="error-message" style="display:none; color: red;"></div> <!-- Error message box -->

      <button id="userInfoSubmitBtn">Start</button>
    </div>


  </div>
</body>
<script>
const allScores = { forward: 0, reverse: 0, digit: 0, trailsA: 0, trailsB: 0, grammar: 0, matrices: 0 };

window.onload = function() {
  document.getElementById("user-info-error").style.display = "none";
};

// lobal state variable
let userInfo = {
  gender: '',
  age: '',
  education: ''
};

document.getElementById("userInfoSubmitBtn").addEventListener("click", function() {
  // Clear previous error messages
  const errorBox = document.getElementById("user-info-error");
  errorBox.textContent = ''; // Clear any previous error message
  errorBox.style.display = "none"; // Hide error box before validation

  // Collect form data
  let gender = document.getElementById("gender").value;
  let age = parseInt(document.getElementById("age").value); // Make sure it's a number
  let education = document.getElementById("education").value;

  // Validate all fields
  if (!gender || !age || !education) {
    errorBox.textContent = "Please fill out all fields before continuing.";
    errorBox.style.display = "block"; // Show the error message
    return;
  }

  // Validate age range
  if (isNaN(age) || age < 10 || age > 120) {
    errorBox.textContent = "Please enter a valid age between 10 and 120.";
    errorBox.style.display = "block"; // Show the error message
    return;
  }

  // Save to userInfo variable
  userInfo.gender = gender;
  userInfo.age = age;
  userInfo.education = education;

  // Hide the user info form modal after validation
  document.getElementById("user-info-modal").style.display = "none";

  // Show the Memory Span test
  document.getElementById("memory-span-test").style.display = "block";

  console.log("User info saved:", userInfo);
});

function showFinalResults(userInfo, allScores, prediction, probability, memoryPercentile, executivePercentile, reasoningPercentile) {
  // Show final results section
   document.getElementById("testTitle").innerText = "🌟 All Tests Completed";
  const finalResults = document.getElementById("final-results");
  finalResults.style.display = "block";
  finalResults.classList.add("fade-in");

  // Set user info
  document.getElementById("user-gender").textContent = userInfo.gender;
  document.getElementById("user-age").textContent = userInfo.age;
  document.getElementById("user-education").textContent = userInfo.education;

  // Set test scores
  document.getElementById("final-forward-score").textContent = allScores.forward;
  document.getElementById("final-reverse-score").textContent = allScores.reverse;
  document.getElementById("final-digit-score").textContent = allScores.digit;
  document.getElementById("final-trailsA-score").textContent = allScores.trailsA;
  document.getElementById("final-trailsB-score").textContent = allScores.trailsB;
  document.getElementById("final-grammar-score").textContent = allScores.grammar;
  document.getElementById("final-matrices-score").textContent = allScores.matrices;

    // Populate the model’s prediction and probability
  document.getElementById("predictionResult").textContent  =
    `Prediction: ${prediction === 1 ? 'Positive' : 'Negative'}`;
  document.getElementById("probabilityResult").textContent =
    `Probability: ${(probability * 100).toFixed(2)}%`;

  // Show percentile results
  const percentileResults = document.getElementById("percentile-results");
  percentileResults.style.display = "block";
  document.getElementById("memory-percentile").textContent = `${memoryPercentile}%`;
  document.getElementById("executive-percentile").textContent = `${executivePercentile}%`;
  document.getElementById("reasoning-percentile").textContent = `${reasoningPercentile}%`;
}


// Submit Function
function submitAllData() {

  // CHANGES MADE
  const memory_score     = (allScores.forward + allScores.reverse) / 2;
  const executive_score  = (allScores.trailsA + allScores.trailsB) / 2;
  const reasoning_score  = (allScores.grammar + allScores.digit + allScores.matrices) / 3;

  const data = {
  participant: userInfo,
  scores: {
    memory_score,
    executive_score,
    reasoning_score
  }
};


  // Send the data to the backend
  fetch('http://localhost:5000/submit', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    // Log the response data to verify it's correct
    console.log("Data submitted successfully:", data);

    // Check if the response contains prediction and probability
    if (data.prediction !== undefined && data.probability !== undefined) {
      // Pass the prediction and probability to showFinalResults
      showFinalResults(userInfo, allScores, data.prediction, data.probability, data.memory_percentile,
      data.executive_percentile, data.reasoning_percentile);
    } else {
      alert("Unexpected response format. Please check the backend.");
    }

    // Alert the user that the data was submitted successfully
    alert("Data submitted successfully!");
  })
  .catch(error => {
    console.error("Error submitting data:", error);
    alert("Error submitting data. Please try again.");
  });
}





  let span = 5, trial = 1, maxTrials = 3, correctCount = 0;
  let phase = "forward", testState = "memory";
  let sequence = [], userSequence = [], timerInterval, currentSymbol = null;

  const digitSymbolLegend = [
    { symbol: "◉", value: "1" }, { symbol: "◍", value: "2" },
    { symbol: "◌", value: "3" }, { symbol: "◕", value: "1" },
    { symbol: "◇", value: "2" }, { symbol: "◖", value: "3" }
  ];

  async function getSequence() {
    const res = await fetch("/get_sequence", {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ span })
    });
    const data = await res.json();
    return data.sequence;
  }

  async function checkSequence(userSeq, correctSeq) {
    const res = await fetch("/check_sequence", {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_sequence: userSeq, correct_sequence: correctSeq })
    });
    return await res.json();
  }

  function flash(boxId) {
    return new Promise(res => {
      const box = document.getElementById(boxId);
      box.innerText = "💃";
      setTimeout(() => { box.innerText = ""; res(); }, 400);
    });
  }

  async function showSequence(seq) {
    for (let idx of seq) {
      await flash("box" + idx);
      await new Promise(r => setTimeout(r, 150));
    }
  }

  function createGrid() {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    for (let i = 0; i < 16; i++) {
      const box = document.createElement("div");
      box.classList.add("box");
      box.id = "box" + i;
      box.onclick = () => {
        if (!box.classList.contains("clicked")) {
          userSequence.push(i);
          box.classList.add("clicked");
        }
      };
      grid.appendChild(box);
    }
  }

  async function runTrial() {
    userSequence = [];
    document.getElementById("submitBtn").disabled = true;
    document.getElementById("result").innerText =
      `${phase === "forward" ? "▶️ Forward" : "🔁 Reverse"} Memory Test – Trial ${trial} of ${maxTrials}`;
    createGrid();
    sequence = await getSequence();
    await showSequence(sequence);
    document.getElementById("submitBtn").disabled = false;
  }

  document.getElementById("submitBtn").onclick = async () => {
    const attempt = phase === "reverse" ? [...userSequence].reverse() : userSequence;
    const res = await checkSequence(attempt, sequence);
    if (res.correct) {
      correctCount++;
      allScores[phase === "forward" ? "forward" : "reverse"]++;
    }
    trial++;
    if (trial <= maxTrials) {
      await runTrial();
    } else if (phase === "forward") {
      phase = "reverse"; trial = 1;
      document.getElementById("result").innerText =
        `✅ Forward done (${allScores.forward}/${maxTrials}). Starting Reverse…`;
      setTimeout(runTrial, 2000);
    } else {
      document.getElementById("result").innerText =
        `✅ Memory done (F:${allScores.forward}, R:${allScores.reverse}).`;
      startDigitSymbolTest();
    }
  };

  function startDigitSymbolTest() {
    document.getElementById("result").style.display = "none";
    document.getElementById("instructions").style.display = "none";
    testState = "digit";
    document.getElementById("testTitle").innerText = "🔢 Digit Symbol Coding Test";
    document.getElementById("grid").style.display = "none";
    document.getElementById("submitBtn").style.display = "none";
    document.getElementById("digit-symbol").style.display = "block";
    renderLegend(); nextSymbol(); startTimer();
  }

  function renderLegend() {
    const legend = document.getElementById("legend-row");
    legend.innerHTML = "";
    digitSymbolLegend.forEach(p => {
      const box = document.createElement("div");
      box.className = "legend-box";
      box.innerHTML = `<div class="legend-symbol">${p.symbol}</div><div class="legend-digit">${p.value}</div>`;
      legend.appendChild(box);
    });
  }

  function nextSymbol() {
    const rand = digitSymbolLegend[Math.floor(Math.random() * digitSymbolLegend.length)];
    currentSymbol = rand;
    document.getElementById("current-symbol").textContent = rand.symbol;
  }

  document.querySelectorAll(".choice-btn").forEach(btn => {
    btn.onclick = () => {
      if (btn.dataset.digit === currentSymbol.value) {
        allScores.digit++;
        document.getElementById("digit-score").textContent = allScores.digit;
      }
      nextSymbol();
    };
  });

  function startTimer() {
    let timeLeft = 90;
    timerInterval = setInterval(() => {
      timeLeft--;
      document.getElementById("timer").innerText = timeLeft;
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        document.querySelectorAll(".choice-btn").forEach(b => b.disabled = true);
        document.getElementById("time-up-overlay").style.display = "flex";
        setTimeout(() => {
          document.getElementById("time-up-overlay").style.display = "none";
          startTrailMakingATest();
        }, 2000);
      }
    }, 1000);
  }

  function startTrailMakingATest() {
    testState = "trailsA";
    hideAllTests();
    document.getElementById("testTitle").innerText = "🔵 Trail Making Test A";
    document.getElementById("trailA-test").style.display = "block";

    const grid = document.getElementById("trailA-grid");
    grid.innerHTML = "";
    const pos = getNonOverlappingPositions(grid, 24);
    let current = 1, startTime = null;
    for (let i = 1; i <= 24; i++) {
      const circle = makeCircle(i, pos[i - 1]);
      circle.onclick = () => {
        if (i === current) {
          if (current === 1) startTime = Date.now();
          markCorrect(circle);
          current++;
          if (current > 24) {
            finalize("trailsA", "trailA-timer", startTime);
            setTimeout(startTrailMakingBTest, 2000);
          }
        } else flashError(circle);
      };
      grid.appendChild(circle);
    }
  }

  function startTrailMakingBTest() {
    testState = "trailsB";
    hideAllTests();
    document.getElementById("testTitle").innerText = "🔵 Trail Making Test B";
    document.getElementById("trailB-test").style.display = "block";

    const grid = document.getElementById("trailB-grid");
    grid.innerHTML = "";
    const nums = Array.from({ length: 12 }, (_, i) => `${i + 1}`);
    const lets = Array.from({ length: 12 }, (_, i) => String.fromCharCode(65 + i));
    const seq = nums.flatMap((n, i) => [n, lets[i]]);
    const pos = getNonOverlappingPositions(grid, 24);
    let currentIndex = 0, startTime = null;
    seq.forEach((label, i) => {
      const circle = makeCircle(label, pos[i]);
      circle.onclick = () => {
        if (label === seq[currentIndex]) {
          if (currentIndex === 0) startTime = Date.now();
          markCorrect(circle);
          currentIndex++;
          if (currentIndex >= seq.length) {
            finalize("trailsB", "trailB-timer", startTime);
            setTimeout(startGrammaticalReasoningTest, 2000);
          }
        } else flashError(circle);
      };
      grid.appendChild(circle);
    });
  }

  function hideAllTests() {
    ["trailA-test", "trailB-test", "digit-symbol", "grid",
     "grammatical", "progressive", "instructions"]
      .forEach(id => document.getElementById(id).style.display = "none");
  }

  function getNonOverlappingPositions(container, count) {
    const W = container.clientWidth, H = container.clientHeight;
    const pos = [];
    while (pos.length < count) {
      const x = Math.random() * (W - 60), y = Math.random() * (H - 60);
      if (pos.every(p => Math.hypot(p.x - x, p.y - y) > 60)) pos.push({ x, y });
    }
    return pos;
  }

  function makeCircle(text, { x, y }) {
    const d = document.createElement("div");
    d.className = "trails-circle"; d.textContent = text;
    d.style.left = `${x}px`; d.style.top = `${y}px`;
    return d;
  }

  function markCorrect(el) { el.classList.add("correct"); }
  function flashError(el) {
    el.classList.add("trail-error");
    setTimeout(() => el.classList.remove("trail-error"), 300);
  }

  function finalize(key, timerId, startTime) {
    const total = ((Date.now() - startTime) / 1000).toFixed(2);
    allScores[key] = parseFloat(total);
    document.getElementById(timerId).textContent = `✅ Completed in ${total} seconds.`;
  }

 function startGrammaticalReasoningTest() {
  hideAllTests();
  document.getElementById("grammatical").style.display = "block";
  document.getElementById("testTitle").innerText = "🗯️ Grammatical Reasoning Test";

  let correctAnswers = 0, incorrectAnswers = 0, trialsCompleted = 0;
  const timeLimit = 45;
  let startTime = Date.now();

  // Function to randomize the position of square and triangle
  function randomizePositions() {
    const positions = ["0", "1"];
    const squarePos = positions[Math.floor(Math.random() * 2)];
    const trianglePos = squarePos === "0" ? "1" : "0";
    document.getElementById("square").style.order = squarePos;
    document.getElementById("triangle").style.order = trianglePos;
  }

  // Function to generate random statements
  function generateStatement() {
    const base = [
      "The triangle is to the left of the square",
      "The square is to the left of the triangle",
      "The triangle is not to the left of the square",
      "The square is not to the left of the triangle"
    ];
    return base[Math.floor(Math.random() * base.length)];
  }

  // Function to check if the statement is true or false
  function isStatementTrue(stmt) {
    const sqLeft = document.getElementById("square").style.order === "0";
    if (stmt.includes("not")) return false;
    if (stmt.includes("triangle is to the left")) return !sqLeft;
    if (stmt.includes("square is to the left")) return sqLeft;
    return false;
  }

  // Function to show the next statement
  function showNext() {
    if (trialsCompleted >= 10) return endTest();
    randomizePositions();
    document.getElementById("statement").textContent = generateStatement();

    // Make the statement text bold
    document.getElementById("statement").style.fontWeight = "bold";
  }

  // Function to handle the user's answer
  function handleAnswer(userAns) {
    const stmt = document.getElementById("statement").textContent;
    if (userAns === isStatementTrue(stmt)) correctAnswers++;
    else incorrectAnswers++;
    trialsCompleted++;
    showNext();
  }

  // Function to update the timer
  function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const rem = timeLimit - elapsed;
    document.getElementById("timer").textContent = `Time: ${rem}s`;
    if (rem <= 0) endTest();
  }

  // Function to end the test
  function endTest() {
    clearInterval(timer);
    allScores.grammar = correctAnswers - incorrectAnswers;
    document.getElementById("score").textContent = `Score: ${allScores.grammar}`;
    document.getElementById("true-btn").disabled = true;
    document.getElementById("false-btn").disabled = true;
    pmTest.start(); // Start the Progressive Matrices Test
    document.getElementById("testTitle").innerText = "🔍 Progressive Matrices Test";
  }

  // Event listeners for the answer buttons
  document.getElementById("true-btn").onclick = () => handleAnswer(true);
  document.getElementById("false-btn").onclick = () => handleAnswer(false);

  // Start the first trial
  showNext();

  // Start the timer
  const timer = setInterval(updateTimer, 1000);
}



  function showBasicResults() {
  const r = document.getElementById("results");
  r.innerText =
    `Forward: ${allScores.forward}, ` +
    `Reverse: ${allScores.reverse}, ` +
    `Digit: ${allScores.digit}, ` +
    `Trail A: ${allScores.trailsA}s, ` +
    `Trail B: ${allScores.trailsB}s, ` +
    `Grammar: ${allScores.grammar}, ` +
    `Matrices: ${allScores.matrices}`;
  r.style.display = "block";
}


  class ProgressiveMatricesTest {
    constructor() {
      this.maxTrials = 17;
      this.current = 0;
      this.score = 0;
      this.incorrectStreak = 0;
      this.symbols = ["●", "▲", "■", "◇", "★"];
      this.gridContainer = document.getElementById("grid-container");
      this.choicesContainer = document.getElementById("choices-container");
      this.pmScore = document.getElementById("pm-score");
      this.pmTrial = document.getElementById("pm-trial");
      this.messageEl = document.getElementById("message");
    }

    generateTrialData() {
      let trials = [];
      for (let i = 0; i < this.maxTrials; i++) {
        let grid = {};
        for (let r = 0; r < 8; r++) {
          grid[r] = this.symbols[(i + r) % this.symbols.length];
        }
        grid[8] = "?";
        const correct = this.symbols[(i + 8) % this.symbols.length];
        let choices = [...this.symbols].sort(() => Math.random() - 0.5);
        if (!choices.includes(correct)) {
          choices[Math.floor(Math.random() * choices.length)] = correct;
        }
        trials.push({ grid, correct, choices });
      }
      return trials;
    }

    display() {
      const t = this.data[this.current];
      this.gridContainer.innerHTML = "";
      for (let i = 0; i < 9; i++) {
        const v = t.grid[i];
        this.gridContainer.innerHTML += `<div class="grid-item">${v === "?" ? "" : v}</div>`;
      }
      this.choicesContainer.innerHTML = "";
      t.choices.forEach(sym => {
        const btn = document.createElement("div");
        btn.className = "choice";
        btn.textContent = sym;
        btn.onclick = () => this.process(sym);
        this.choicesContainer.appendChild(btn);
      });
      this.pmTrial.textContent = `${this.current + 1}/${this.maxTrials}`;
    }

    process(selection) {
      const t = this.data[this.current];
      if (selection === t.correct) {
        this.score++;
        this.incorrectStreak = 0;
      } else {
        this.incorrectStreak++;
      }
      this.pmScore.textContent = this.score;
      if (this.incorrectStreak >= 3 || this.current === this.maxTrials - 1) {
        this.messageEl.textContent = `✅ Test Ended! Final Score: ${this.score}`;
        hideAllTests();
        allScores.matrices = this.score;
      setTimeout(() => showFinalResults(userInfo, allScores), 500);
      } else {
        this.current++;
        this.display();
      }
    }

    start() {
      hideAllTests();
      document.getElementById("progressive").style.display = "block";
      this.current = 0;
      this.score = 0;
      this.incorrectStreak = 0;
      this.data = this.generateTrialData();
      this.messageEl.textContent = "";
      this.display();
    }
  }

  const pmTest = new ProgressiveMatricesTest();

  document.getElementById("startBtn").onclick = async () => {
    document.getElementById("startBtn").style.display = "none";
    phase = "forward"; trial = 1; correctCount = 0;
    allScores.forward = allScores.reverse = 0;
    await runTrial();
  };
</script>
</html>

